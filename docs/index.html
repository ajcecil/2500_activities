<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Soil Texture Calculator & Triangle</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#fff; color:#000; }
    header { padding:20px 24px; border-bottom:1px solid #ccc; }
    h1 { margin:0; font-size:22px; }
    .wrap { display:grid; grid-template-columns:360px 1fr; gap:20px; padding:20px; }
    .card { background:#f9f9f9; border:1px solid #ccc; border-radius:8px; height:1600px; }
    .panel { padding:18px; }
    .row { display:grid; grid-template-columns:1fr 120px; gap:12px; align-items:center; margin-bottom:14px; }
    label { font-size:14px; color:#333; }
    input[type="number"] { width:100%; padding:8px; border-radius:6px; border:1px solid #aaa; background:#fff; color:#000; }
    input[readonly] { background:#eee; }
    .help { font-size:12px; color:#555; margin-top:6px; }
    .good { color:green; }
    .bad { color:red; }
    .btns { display:flex; gap:10px; margin-top:10px; }
    button { padding:8px 12px; border:1px solid #aaa; background:#fff; color:#000; border-radius:6px; cursor:pointer; }
    button:hover { background:#eee; }
    #chart { height:520px; width:100%; }
    .legend { font-size:13px; color:#444; margin-top:10px; line-height:1.4; }
    .pill { display:inline-block; padding:3px 8px; border:1px solid #aaa; border-radius:999px; margin-right:6px; }
  </style>
</head>
<body>
<header>
  <h1>Soil Texture Calculator & Ternary Plot (USDA: Clay–Silt–Sand)</h1>
</header>

<div class="wrap">
  <!-- Controls -->
  <div class="card">
    <div class="panel">
      <div class="row">
        <label for="clay">Clay (%)</label>
        <input id="clay" type="number" min="0" max="100" step="0.1" value="20" />
      </div>
      <div class="row">
        <label for="sand">Sand (%)</label>
        <input id="sand" type="number" min="0" max="100" step="0.1" value="50" />
      </div>
      <div class="row">
        <label for="silt">Silt (%) (computed)</label>
        <input id="silt" type="number" step="0.1" value="30" readonly />
      </div>
      <div class="help" id="status">Enter clay and sand; silt is 100 − clay − sand.</div>
      <div class="btns">
        <button id="snap">Snap to whole %</button>
        <button id="reset">Reset</button>
      </div>
      <div class="legend">
        <div class="pill">Top vertex: <b>Clay</b></div>
        <div class="pill">Bottom right: <b>Silt</b></div>
        <div class="pill">Bottom left: <b>Sand</b></div>
      </div>
    </div>
  </div>

  <!-- Chart -->
  <div class="card">
    <div class="panel" style="padding:12px 12px 0 12px;">
      <div id="chart"></div>
    </div>
  </div>
</div>

<script>
function clamp(n,min,max){return Math.min(Math.max(n,min),max);}
function fix(n){return Number.isFinite(n)?Number(n.toFixed(2)):0;}

const clayEl=document.getElementById('clay');
const sandEl=document.getElementById('sand');
const siltEl=document.getElementById('silt');
const statusEl=document.getElementById('status');

// USDA polygons (simplified shading, from your R usda_soil_triangles)
const polygons = [
  {class:"Sand",a:[0,10,0,0],b:[100,90,85,100],c:[0,0,15,0],color:"rgba(255,223,128,0.4)"},
  {class:"Loamy Sand",a:[0,10,15,0],b:[85,90,85,70,85],c:[15,0,0,30,15],color:"rgba(255,239,170,0.4)"},
  {class:"Sandy Loam",a:[0,15,20,20,7.5,7.5,0,0],b:[70,85,80,52.5,52.5,42.5,50,70],c:[30,0,0,27.5,42.5,50,50,30],color:"rgba(255,255,170,0.4)"},
  {class:"Loam",a:[7.5,20,27.5,27.5,7.5,7.5],b:[52.5,52.5,45,22.5,42.5,52.5],c:[42.5,27.5,27.5,50,50,42.5],color:"rgba(200,255,200,0.4)"},
  {class:"Silt Loam",a:[0,27.5,27.5,12.5,12.5,0,0],b:[50,22.5,0,0,7.5,20,50],c:[50,50,72.5,87.5,50],color:"rgba(170,220,255,0.4)"},
  {class:"Silt",a:[0,12.5,12.5,0,0],b:[20,7.5,0,0,20],c:[80,80,87.5,100,80],color:"rgba(140,200,255,0.4)"},
  {class:"Sandy Clay Loam",a:[20,35,35,27.5,20,20],b:[80,65,45,45,52.5,80],c:[0,0,20,27.5,27.5,0],color:"rgba(255,200,150,0.4)"},
  {class:"Clay Loam",a:[27.5,40,40,27.5,27.5],b:[45,45,20,20,45],c:[27.5,15,40,52.5,27.5],color:"rgba(230,180,150,0.4)"},
  {class:"Silty Clay Loam",a:[27.5,40,40,27.5,27.5],b:[20,20,0,0,20],c:[52.5,40,60,72.5,52.5],color:"rgba(200,180,220,0.4)"},
  {class:"Sandy Clay",a:[35,55,35,35],b:[65,45,45,65],c:[0,0,20,0],color:"rgba(255,150,150,0.4)"},
  {class:"Silty Clay",a:[40,60,40,40],b:[20,0,0,20],c:[40,40,60,40],color:"rgba(200,150,200,0.4)"},
  {class:"Clay",a:[40,55,100,60,40,40],b:[45,45,0,0,20,45],c:[15,0,0,40,40,15],color:"rgba(200,100,100,0.4)"}
];

// Build polygon traces
const polygonTraces=polygons.map(poly=>({
  type:"scatterternary",mode:"lines",
  a:[...poly.a,poly.a[0]],
  b:[...poly.b,poly.b[0]],
  c:[...poly.c,poly.c[0]],
  fill:"toself",fillcolor:poly.color,
  line:{color:"black",width:1},
  name:poly.class,hoverinfo:"skip"
}));

// Movable marker
let pointTrace={
  type:'scatterternary',mode:'markers+text',
  a:[20],b:[50],c:[30],
  marker:{size:18,color:'red'},
  text:["Loam"],textposition:'top center',
  hovertemplate:'Clay: %{a}%<br>Sand: %{b}%<br>Silt: %{c}%<br>Texture Class: %{text}<extra></extra>'
};

const layout={
  paper_bgcolor:'#fff',plot_bgcolor:'#fff',
  ternary:{sum:100,
    aaxis:{title:{text:'Clay'},min:0,ticksuffix:'%'},
    baxis:{title:{text:'Sand'},min:0,ticksuffix:'%'},
    caxis:{title:{text:'Silt'},min:0,ticksuffix:'%'}
  },
  width:1400,height:900,showlegend:false
};

Plotly.newPlot('chart',[...polygonTraces,pointTrace],layout);

// USDA rule-based classification (simplified)
function classify(clay,sand,silt){
  if(clay>=40 && silt>=40) return "Silty Clay";
  if(clay>=40 && sand>=45) return "Sandy Clay";
  if(clay>=40) return "Clay";
  if(clay>=27 && clay<40 && sand>20 && sand<=45 && silt>15 && silt<=53) return "Clay Loam";
  if(clay>=20 && clay<35 && silt>=28 && silt<50 && sand<=52) return "Silty Clay Loam";
  if(clay>=20 && clay<35 && sand>45 && sand<65 && silt<=28) return "Sandy Clay Loam";
  if(clay>=7 && clay<27 && silt>=28 && silt<50 && sand>23 && sand<52) return "Loam";
  if(silt>=50 && clay<27) return "Silt Loam";
  if(silt>=80 && clay<12) return "Silt";
  if(sand>=43 && sand<=85 && clay>=7 && clay<=20 && silt>=0 && silt<=50) return "Sandy Loam";
  if(sand>=85 && clay<10) return "Loamy Sand";
  if(sand>=90 && clay<10) return "Sand";
  return "Loam";
}

function update(){
  let clay=parseFloat(clayEl.value);let sand=parseFloat(sandEl.value);
  if(!Number.isFinite(clay)) clay=0; if(!Number.isFinite(sand)) sand=0;
  clay=clamp(clay,0,100); sand=clamp(sand,0,100);
  const silt=100-clay-sand; siltEl.value=fix(silt);
  if(clay+sand>100||silt<0){statusEl.textContent=`Invalid input`;statusEl.className='help bad';}
  else{statusEl.textContent=`OK ✔ Total = ${fix(clay+sand+silt)}%`;statusEl.className='help good';}
  const cls=classify(clay,sand,silt);
  Plotly.restyle('chart',{a:[[clay]],b:[[sand]],c:[[silt]],text:[[cls]]},[polygonTraces.length]);
}

clayEl.addEventListener('input',update);
sandEl.addEventListener('input',update);
document.getElementById('snap').addEventListener('click',()=>{clayEl.value=Math.round(parseFloat(clayEl.value||'0'));sandEl.value=Math.round(parseFloat(sandEl.value||'0'));update();});
document.getElementById('reset').addEventListener('click',()=>{clayEl.value=20;sandEl.value=50;update();});

update();
window.addEventListener('resize',()=>Plotly.Plots.resize('chart'));
</script>
</body>
</html>
